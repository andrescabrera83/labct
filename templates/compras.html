{% extends "base.html" %}
{% block title %}Materias Primas{% endblock %}

{% block content %}

<style>
    .hidden {
        display: none;
    }

    #tableContainer {
        transition: max-height 0.5s ease;
        overflow: hidden;
        max-height: 0;
        margin-top: 10px;
        display: flex;
        flex-direction: column;
    }

    .ferramentas {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding-block: 9px;

    }

    .ativarManual {
        margin-left: 18px;
        align-self: center;
        margin-bottom: 12px;
    }

    #submitButton[disabled] {
        background-color: #ddd;
        /* Change background color */
        color: #888;
        /* Change text color */
        cursor: not-allowed;
        /* Change cursor to indicate unclickable */
        opacity: 0.6;
        /* Reduce opacity */
    }

    #filterForm input[type="radio"]:checked+label {
        text-decoration: underline;
        /* Add underline text decoration */
    }

    @import url("https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css");


table {
  width: 100%;
}


table th,
table td {
  padding: 0.4em;
}

table.fold-table>tbody>tr.view td,
table.fold-table>tbody>tr.view th {
  cursor: pointer;
 

}

table.fold-table>tbody>tr.view td:first-child,
table.fold-table>tbody>tr.view th:first-child {
  position: relative;
  padding-left: 20px;
}

table.fold-table>tbody>tr.view td:first-child:before,
table.fold-table>tbody>tr.view th:first-child:before {
  position: absolute;
  top: 50%;
  left: 20px;
  width: 9px;
  height: 16px;
  margin-top: -8px;
  font: 16px fontawesome;
  color: #999;
  content: "▼";

  transition: all 0.3s ease;
}

table.fold-table>tbody>tr.view:hover {
  background: #eeeeee;
  text-decoration: underline;
}

table.fold-table>tbody>tr.view.open {
    
  background: rgb(255, 230, 129);
  color: rgb(0, 0, 0);
  height: 50px;
  font-size: large;
  font-weight: 500;
  text-decoration: underline;
}



table.fold-table>tbody>tr.view.open td:first-child:before,
table.fold-table>tbody>tr.view.open th:first-child:before {
  transform-origin: right;
  transform: rotate(180deg);
  color: #000000;


}

table.fold-table>tbody>tr.fold {
  display: none;
}

table.fold-table>tbody>tr.fold.open {
  display: table-row;
  background: rgb(255, 255, 255);
}

table.fold-table>tbody>tr.fold.open:hover {
    background-color: rgb(216, 216, 216);
}


.fold-content {
  padding: 0.5em;

}

.fold-content h3 {
  margin-top: 0;
}

.listaDado{
    background-color: white;
}

.listaDado:hover{
    background-color: white;
}


</style>

<body>

    <div class="container">
        <div class="tabela">
            <h3 style="margin-bottom: 25px;"> Compras </h3>

            <button id="expandBtn" class="btn-cadastrar" > + Fazer Novo Pedido De Compra</button>

            <div id="tableContainer" class="hidden">


                <div class="ferramentas">
                    <form id="filterForm">
                        <input type="radio" name="filterOption" value="all" id="allOption" checked>
                        <label for="allOption">Todos</label>

                        <input type="radio" name="filterOption" value="comprar" id="comprarOption">
                        <label for="comprarOption">Comprar</label>

                        <input type="radio" name="filterOption" value="ok" id="okOption">
                        <label for="okOption">OK</label>
                    </form>

                    <div class="ativarManual">
                        <button class="btn-ferramenta" id="manualChangeBtn">Digitar Pedido</button>
                        <button class="btn-ferramenta" type="button" id="resetButton">Resetar Valores</button>
                    </div>
                </div>


                <form id="myForm" action="/salvar_compra" method="POST">
                    <div id="tableFilter">

                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all"></th>
                                    <th style="width: 5%;">codigo</th>
                                    <th>materia prima</th>
                                    <th>unidade</th>
                                    <th>estoque</th>
                                    <th style="width: 10%;">consumo medio semanal</th>
                                    <th>necesidade</th>
                                    <th>indicador</th>
                                    <th>compra minima</th>
                                    <th>|</th>
                                    <th style="width: 20%;">pedido</th>

                                    <th>fornecedor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for estq in estoque %}
                                <tr>
                                    <td><input type="checkbox" class="select-row" name="selected_items"
                                            value="{{ estq.nome_mp }}"> </td>
                                    <td>{{ estq.id_mp }}</td>
                                    <td style="font-weight: bolder;"><b>{{ estq.nome_mp }}</b></td>
                                    <td>{{ estq.unidade_mp }}</td>
                                    <td>{{ estq.quantidade_estq }}</td>
                                    <td>{{ estq.gms_mp }}</td>
                                    <td
                                        style="background-color: {% if estq.gms_mp - estq.quantidade_estq > 0 %}yellow; color: red; font-weight: bold;{% else %}lightgreen; color: darkgreen;{% endif %}">
                                        {{ estq.gms_mp - estq.quantidade_estq }}
                                    </td>
                                    <td
                                        style="background-color: {% if estq.gms_mp - estq.quantidade_estq > 0 %}yellow; color: red; font-weight: bold;{% else %}lightgreen; color: darkgreen;{% endif %}">
                                        {% if estq.gms_mp - estq.quantidade_estq > 0 %}
                                        Comprar
                                        {% else %}
                                        OK
                                        {% endif %}
                                    </td>
                                    <td>{{ estq.pedidomin_mp }}</td>
                                    <td>|</td>
                                    <td>
                                        <span class="quantity">{{ estq.gms_mp - estq.quantidade_estq }}</span>
                                        <input type="number" step="0.001" name="pedido_comprasd" id="pedido_comprasd"
                                            value="{{ estq.gms_mp - estq.quantidade_estq }}" class="hidden">
                                    </td>

                                    <td>
                                        <select disabled name="fornecedores" id="fornecedores">
                                            {% if fornecedores %}
                                            {% for fornecedor in fornecedores %}
                                            <option value="" selected disabled hidden>Seleccionar Fornecedor</option>
                                            <option value="{{ fornecedor.nome_fornecedor }}">{{
                                                fornecedor.nome_fornecedor }}</option>
                                            {% endfor %}
                                            {% else %}
                                            <option value="" disabled selected>Sem Fornecedores cadastrados</option>

                                            {% endif %}
                                        </select>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <div style="display: flex;
                            justify-content: end;
                            margin-block: 24px;
                            margin-inline: 3px;
                            height: 50px !important;">
                            <button type="submit" id="submitButton" class="btn btn-dark disabled" disabled>Fazer
                                Pedido</button>
                        </div>

                    </div>
                </form>

            </div>

            <div class="listaCompras">

                <h4>Compras Pendentes</h4>

                <table id="myTable" class="fold-table parent-table" >
                    <thead>
                        <tr>
                            <th style="width: 8%;">codigo do pedido</th>
                            <th>data do pedido</th>
                            <th style="width: 8%;">Situação</th>
                        </tr>
                    </thead>
                    <tbody class="tbody-parent">
                        {% for compras in compras%}
                        <tr class="view">
                            <td>{{compras.id_compras}}</td>
                            <td style="font-weight: 600;">{{compras.data_compras | datetimeformat}}</td>
                            <td>{{compras.estado_compras}}</td>

                        </tr>
                        <tr class="fold">
                            <td colspan="7">
                                <div class="fold-content" >

                                    <table>
                                        <thead>
                                            <tr>
                                                
                                                <th>Fornecedor</th>
                                                <th>Departamento</th>
                                                <th>Produto</th>
                                                <th>Pedido</th>
                                                <th>Unidade</th>
                                                <th>Valor Do Pedido</th>
                                                <th>Previsao de entrega</th>
                                                <th>Data De Vencimento</th>
                                                <th>Conferencia Manual</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                            {% for comprasdados in comprasdados %}
                                            {% if comprasdados.id_compras == compras.id_compras %}
                                            <tr class="listaDado">

                                                <td>{{comprasdados.fornecedor_comprasd}}</td>
                                                <td>{{comprasdados.departamento_comprasd}}</td>
                                                <td>{{comprasdados.nome_mp}}</td>
                                                <td>{{comprasdados.pedido_comprasd}}</td>
                                                <td>{{comprasdados.unidade_mp}}</td>
                                                <td>R${{comprasdados.valorpedido_comprasd}}</td>
                                                <td>{{comprasdados.previsao_comprasd}}</td>
                                                <td>{{comprasdados.vencimento_comprasd}}</td>
                                                <td>Conferencia Manual</td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}

                                        </tbody>
                                    </table>

                                </div>
                                
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>


            </div>

            <br>

            
        </div>



    </div>
</body>

<script>

    $(function () {
        $(".fold-table tr.view").on("click", function () {
            $(this).toggleClass("open").next(".fold").toggleClass("open");
            // Get the target component relative to the clicked row
            const targetElement = $(this).next(".fold").find(".target-component");

            // Scroll to the target component
            scrollToComponent(targetElement);
        });
    });

    function scrollToComponent(targetElement) {
        // Calculate the target scroll position
        // Adjust this value to set the space at the top
        const offset = 40;
        const targetScrollPosition = targetElement.offset().top - offset;

        // Scroll to the target position
        window.scrollTo({
            top: targetScrollPosition,
            behavior: 'smooth' // Optional: Use smooth scrolling
        });
    }

</script>

<script>
    // jQuery code for filtering the table
    $(document).ready(function () {
        // Add event listener for form changes
        $('#filterForm input[type="radio"]').change(filterTable);

        function filterTable() {
            // Get the selected filter option
            var selectedOption = $('#filterForm input[name="filterOption"]:checked').val();

            // Get the table rows
            var rows = $('#tableFilter table tbody tr');

            // Loop through all table rows
            rows.each(function () {
                // Get the cell containing the indicator text
                var cell = $(this).find('td:eq(7)'); // Adjust index as needed

                // Get the indicator text content and convert to lowercase
                var indicatorText = cell.text().trim().toLowerCase();

                // Show or hide rows based on the selected filter option
                if (selectedOption === 'all' || indicatorText === selectedOption) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
    });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Select all checkbox functionality
        $('#select-all').change(function () {
            $('.select-row:visible').prop('checked', $(this).prop('checked'));
            toggleSubmitButtonState();
        });

        // Individual row checkbox functionality
        $('.select-row').change(function () {
            if ($('.select-row:checked').length === $('.select-row:visible').length) {
                $('#select-all').prop('checked', true);
            } else {
                $('#select-all').prop('checked', false);
            }

            toggleSubmitButtonState();
        });

        // Function to toggle submit button state based on selected rows
        function toggleSubmitButtonState() {
            if ($('.select-row:checked').length > 0) {
                $('#submitButton').removeClass('disabled').prop('disabled', false);
            } else {
                $('#submitButton').addClass('disabled').prop('disabled', true);
            }
        }
    });
</script>

<script>
    document.getElementById('manualChangeBtn').addEventListener('click', function () {
        var spans = document.querySelectorAll('.quantity');
        var inputs = document.querySelectorAll('input[type="number"]');
        var submitButton = document.getElementById('submitButton');
        var selects = document.querySelectorAll('select[name="fornecedores"]'); // Get all select elements with name "fornecedores"
        for (var i = 0; i < spans.length; i++) {
            spans[i].classList.toggle('hidden');
        }
        for (var i = 0; i < inputs.length; i++) {
            inputs[i].classList.toggle('hidden');
        }
        /*submitButton.classList.toggle('hidden');*/

        // Toggle the disabled attribute of all select elements
        selects.forEach(function (select) {
            if (select.options.length > 0) {
                select.disabled = !select.disabled;
            }
        });
    });
</script>

<script>
    document.getElementById("expandBtn").addEventListener("click", function () {
        var tableContainer = document.getElementById("tableContainer");
        if (tableContainer.classList.contains("hidden")) {
            tableContainer.classList.remove("hidden");
            setTimeout(function () {
                tableContainer.style.maxHeight = tableContainer.scrollHeight + "px";
            }, 10);
        } else {
            tableContainer.style.maxHeight = null;
            tableContainer.classList.add("hidden");
        }
    });
</script>

<script>
    document.getElementById('resetButton').addEventListener('click', function () {
        document.getElementById('myForm').reset(); // Reset the form
    });
</script>

<script>
    // Function to reverse the order of table rows
    function reverseTable() {
      var table = document.querySelector(".parent-table");
      var tbody = table.querySelector("tbody-parent");
      var rows = tbody.querySelectorAll("tr.view");
      var rowsArray = Array.prototype.slice.call(rows);
      rowsArray.reverse();
      for (var i = 0; i < rowsArray.length; i++) {
        tbody.appendChild(rowsArray[i]);
      }
    }
  
    // Call the function to reverse the table order
    reverseTable();
  </script>



  <!-- Bootstrap JS -->
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


{% endblock %}